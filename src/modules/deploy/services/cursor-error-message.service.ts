import { Injectable } from '@nestjs/common';
import { 
  CursorDeploymentError, 
  CursorDeploymentErrorCode, 
  ErrorSeverity 
} from '../errors/cursor-deploy.error';
import { RecoveryResult } from './cursor-error-recovery.service';
import { IntegrityCheckResult } from './cursor-rollback.service';

/**
 * Ïò§Î•ò Î©îÏãúÏßÄ ÌÖúÌîåÎ¶ø Ïù∏ÌÑ∞ÌéòÏù¥Ïä§
 */
export interface ErrorMessageTemplate {
  title: string;
  description: string;
  icon: string;
  color: 'red' | 'yellow' | 'blue' | 'green';
  sections: ErrorMessageSection[];
}

/**
 * Ïò§Î•ò Î©îÏãúÏßÄ ÏÑπÏÖò Ïù∏ÌÑ∞ÌéòÏù¥Ïä§
 */
export interface ErrorMessageSection {
  type: 'info' | 'warning' | 'error' | 'success' | 'steps' | 'code';
  title?: string;
  content: string | string[];
  collapsible?: boolean;
  expanded?: boolean;
}

/**
 * ÏÇ¨Ïö©Ïûê ÏπúÌôîÏ†Å Ïò§Î•ò Î©îÏãúÏßÄ ÏÉùÏÑ± ÏÑúÎπÑÏä§
 * 
 * Ïù¥ ÏÑúÎπÑÏä§Îäî Cursor IDE Î∞∞Ìè¨ Ïò§Î•òÎ•º ÏÇ¨Ïö©ÏûêÍ∞Ä Ïù¥Ìï¥ÌïòÍ∏∞ Ïâ¨Ïö¥ ÌòïÌÉúÎ°ú Î≥ÄÌôòÌïòÍ≥†,
 * Íµ¨Ï≤¥Ï†ÅÏù∏ Ìï¥Í≤∞ Î∞©Î≤ïÍ≥º Îã§Ïùå Îã®Í≥ÑÎ•º Ï†úÍ≥µÌï©ÎãàÎã§.
 */
@Injectable()
export class CursorErrorMessageService {
  
  /**
   * Ïò§Î•òÏóê ÎåÄÌïú ÏÇ¨Ïö©Ïûê ÏπúÌôîÏ†Å Î©îÏãúÏßÄ ÏÉùÏÑ±
   */
  generateUserFriendlyMessage(error: CursorDeploymentError): ErrorMessageTemplate {
    const template = this.getBaseTemplate(error);
    
    // Ïò§Î•ò ÏΩîÎìúÎ≥Ñ ÎßûÏ∂§ Î©îÏãúÏßÄ ÏÉùÏÑ±
    switch (error.code) {
      case CursorDeploymentErrorCode.PERMISSION_DENIED:
        return this.generatePermissionDeniedMessage(error, template);
      
      case CursorDeploymentErrorCode.DISK_FULL:
        return this.generateDiskFullMessage(error, template);
      
      case CursorDeploymentErrorCode.TRANSFORMATION_FAILED:
        return this.generateTransformationFailedMessage(error, template);
      
      case CursorDeploymentErrorCode.SECURITY_THREAT_DETECTED:
        return this.generateSecurityThreatMessage(error, template);
      
      case CursorDeploymentErrorCode.TIMEOUT:
        return this.generateTimeoutMessage(error, template);
      
      case CursorDeploymentErrorCode.ROLLBACK_FAILED:
        return this.generateRollbackFailedMessage(error, template);
      
      case CursorDeploymentErrorCode.NETWORK_ERROR:
        return this.generateNetworkErrorMessage(error, template);
      
      case CursorDeploymentErrorCode.FILE_CORRUPTION:
        return this.generateFileCorruptionMessage(error, template);
      
      default:
        return this.generateGenericErrorMessage(error, template);
    }
  }

  /**
   * Î≥µÍµ¨ Í≤∞Í≥ºÏóê ÎåÄÌïú Î©îÏãúÏßÄ ÏÉùÏÑ±
   */
  generateRecoveryMessage(recoveryResult: RecoveryResult): ErrorMessageTemplate {
    const template: ErrorMessageTemplate = {
      title: recoveryResult.success ? 'Recovery Completed' : 'Recovery Failed',
      description: recoveryResult.message,
      icon: recoveryResult.success ? '‚úÖ' : '‚ùå',
      color: recoveryResult.success ? 'green' : 'red',
      sections: [],
    };

    // Î≥µÏõêÎêú ÌååÏùº Ï†ïÎ≥¥
    if (recoveryResult.restoredFiles.length > 0) {
      template.sections.push({
        type: 'success',
        title: 'Successfully Restored Files',
        content: recoveryResult.restoredFiles,
        collapsible: true,
        expanded: false,
      });
    }

    // Ïã§Ìå®Ìïú ÌååÏùº Ï†ïÎ≥¥
    if (recoveryResult.failedFiles.length > 0) {
      template.sections.push({
        type: 'error',
        title: 'Failed to Restore Files',
        content: recoveryResult.failedFiles,
        collapsible: true,
        expanded: true,
      });
    }

    // Í≤ΩÍ≥† Î©îÏãúÏßÄ
    if (recoveryResult.warnings.length > 0) {
      template.sections.push({
        type: 'warning',
        title: 'Warnings',
        content: recoveryResult.warnings,
      });
    }

    // Î¨¥Í≤∞ÏÑ± Í≤ÄÏÇ¨ Í≤∞Í≥º
    if (!recoveryResult.integrityCheck) {
      template.sections.push({
        type: 'warning',
        title: 'Integrity Check Failed',
        content: [
          'Some configuration files may be corrupted or missing.',
          'Please verify Cursor IDE functionality before proceeding.',
          'Consider running a manual integrity check.',
        ],
      });
    }

    return template;
  }

  /**
   * Î¨¥Í≤∞ÏÑ± Í≤ÄÏÇ¨ Í≤∞Í≥º Î©îÏãúÏßÄ ÏÉùÏÑ±
   */
  generateIntegrityCheckMessage(result: IntegrityCheckResult): ErrorMessageTemplate {
    const template: ErrorMessageTemplate = {
      title: result.valid ? 'Integrity Check Passed' : 'Integrity Issues Found',
      description: `Checked ${result.summary.totalFiles} files, found ${result.issues.length} issues`,
      icon: result.valid ? '‚úÖ' : '‚ö†Ô∏è',
      color: result.valid ? 'green' : 'yellow',
      sections: [],
    };

    // ÏöîÏïΩ Ï†ïÎ≥¥
    template.sections.push({
      type: 'info',
      title: 'Summary',
      content: [
        `Total files: ${result.summary.totalFiles}`,
        `Valid files: ${result.summary.validFiles}`,
        `Corrupted files: ${result.summary.corruptedFiles}`,
        `Missing files: ${result.summary.missingFiles}`,
      ],
    });

    // Î¨∏Ï†úÎ≥Ñ Î∂ÑÎ•ò
    if (result.issues.length > 0) {
      const criticalIssues = result.issues.filter(i => i.severity === 'critical');
      const highIssues = result.issues.filter(i => i.severity === 'high');
      const mediumIssues = result.issues.filter(i => i.severity === 'medium');
      const lowIssues = result.issues.filter(i => i.severity === 'low');

      if (criticalIssues.length > 0) {
        template.sections.push({
          type: 'error',
          title: `Critical Issues (${criticalIssues.length})`,
          content: criticalIssues.map(issue => `${issue.filePath}: ${issue.description}`),
          expanded: true,
        });
      }

      if (highIssues.length > 0) {
        template.sections.push({
          type: 'warning',
          title: `High Priority Issues (${highIssues.length})`,
          content: highIssues.map(issue => `${issue.filePath}: ${issue.description}`),
          collapsible: true,
          expanded: true,
        });
      }

      if (mediumIssues.length > 0) {
        template.sections.push({
          type: 'warning',
          title: `Medium Priority Issues (${mediumIssues.length})`,
          content: mediumIssues.map(issue => `${issue.filePath}: ${issue.description}`),
          collapsible: true,
          expanded: false,
        });
      }

      if (lowIssues.length > 0) {
        template.sections.push({
          type: 'info',
          title: `Low Priority Issues (${lowIssues.length})`,
          content: lowIssues.map(issue => `${issue.filePath}: ${issue.description}`),
          collapsible: true,
          expanded: false,
        });
      }
    }

    return template;
  }

  /**
   * Í∏∞Î≥∏ ÌÖúÌîåÎ¶ø ÏÉùÏÑ±
   */
  private getBaseTemplate(error: CursorDeploymentError): ErrorMessageTemplate {
    const severityConfig = {
      [ErrorSeverity.LOW]: { icon: '‚ÑπÔ∏è', color: 'blue' as const },
      [ErrorSeverity.MEDIUM]: { icon: '‚ö†Ô∏è', color: 'yellow' as const },
      [ErrorSeverity.HIGH]: { icon: '‚ùå', color: 'red' as const },
      [ErrorSeverity.CRITICAL]: { icon: 'üö®', color: 'red' as const },
    };

    const config = severityConfig[error.severity];

    return {
      title: this.getErrorTitle(error.code),
      description: error.message,
      icon: config.icon,
      color: config.color,
      sections: [],
    };
  }

  /**
   * Í∂åÌïú Í±∞Î∂Ä Ïò§Î•ò Î©îÏãúÏßÄ
   */
  private generatePermissionDeniedMessage(
    error: CursorDeploymentError,
    template: ErrorMessageTemplate,
  ): ErrorMessageTemplate {
    template.sections.push(
      {
        type: 'error',
        title: 'What happened?',
        content: [
          'The deployment process was denied access to write files in the Cursor IDE directory.',
          'This usually happens when the current user doesn\'t have sufficient permissions.',
        ],
      },
      {
        type: 'steps',
        title: 'How to fix this:',
        content: [
          '1. Close Cursor IDE completely',
          '2. Run one of these commands in your terminal:',
          '',
          '   Option A - Fix permissions:',
          `   chmod 755 "${error.context.targetPath || '~/.cursor'}"`,
          '',
          '   Option B - Change ownership:',
          `   chown $USER "${error.context.targetPath || '~/.cursor'}"`,
          '',
          '   Option C - Run with elevated privileges:',
          '   sudo taptik deploy --platform cursor-ide',
          '',
          '3. Try the deployment again',
        ],
      },
      {
        type: 'warning',
        title: 'Important Notes',
        content: [
          '‚Ä¢ Make sure Cursor IDE is completely closed before fixing permissions',
          '‚Ä¢ Option C (sudo) should be used as a last resort',
          '‚Ä¢ Contact your system administrator if you\'re on a managed system',
        ],
      },
    );

    return template;
  }

  /**
   * ÎîîÏä§ÌÅ¨ Í≥µÍ∞Ñ Î∂ÄÏ°± Ïò§Î•ò Î©îÏãúÏßÄ
   */
  private generateDiskFullMessage(
    error: CursorDeploymentError,
    template: ErrorMessageTemplate,
  ): ErrorMessageTemplate {
    const requiredSpace = error.details.requiredSpace || 'unknown';
    const availableSpace = error.details.availableSpace || 'unknown';

    template.sections.push(
      {
        type: 'error',
        title: 'What happened?',
        content: [
          'There isn\'t enough disk space to complete the deployment.',
          `Required: ${requiredSpace}MB, Available: ${availableSpace}MB`,
        ],
      },
      {
        type: 'steps',
        title: 'How to fix this:',
        content: [
          '1. Free up disk space by:',
          '   ‚Ä¢ Emptying trash/recycle bin',
          '   ‚Ä¢ Removing large unused files',
          '   ‚Ä¢ Cleaning up downloads folder',
          '   ‚Ä¢ Running disk cleanup utilities',
          '',
          '2. Alternative solutions:',
          '   ‚Ä¢ Deploy to a different location with more space',
          '   ‚Ä¢ Use external storage for large files',
          '   ‚Ä¢ Deploy only essential components with --components flag',
          '',
          '3. Try the deployment again',
        ],
      },
      {
        type: 'code',
        title: 'Quick disk cleanup commands:',
        content: [
          '# Check disk usage',
          'df -h',
          '',
          '# Find large files',
          'du -h ~ | sort -hr | head -20',
          '',
          '# Clean package caches (if applicable)',
          'npm cache clean --force',
          'yarn cache clean',
        ],
      },
    );

    return template;
  }

  /**
   * Î≥ÄÌôò Ïã§Ìå® Ïò§Î•ò Î©îÏãúÏßÄ
   */
  private generateTransformationFailedMessage(
    error: CursorDeploymentError,
    template: ErrorMessageTemplate,
  ): ErrorMessageTemplate {
    const component = error.details.component || 'unknown component';
    const reason = error.details.reason || 'unknown reason';

    template.sections.push(
      {
        type: 'error',
        title: 'What happened?',
        content: [
          `Failed to convert ${component} to Cursor IDE format.`,
          `Reason: ${reason}`,
          'This usually means the source configuration has incompatible or corrupted data.',
        ],
      },
      {
        type: 'steps',
        title: 'How to fix this:',
        content: [
          '1. Verify source configuration:',
          '   ‚Ä¢ Check if the original configuration file is valid',
          '   ‚Ä¢ Ensure all required fields are present',
          '   ‚Ä¢ Look for any corrupted or malformed data',
          '',
          '2. Try partial deployment:',
          '   taptik deploy --platform cursor-ide --components settings,extensions',
          '',
          '3. Use validation mode first:',
          '   taptik deploy --platform cursor-ide --validate-only',
          '',
          '4. Check compatibility:',
          '   ‚Ä¢ Some features may not be supported in Cursor IDE',
          '   ‚Ä¢ Review the compatibility documentation',
        ],
      },
      {
        type: 'info',
        title: 'Need more details?',
        content: [
          'Run with verbose output to see detailed transformation logs:',
          'taptik deploy --platform cursor-ide --verbose',
        ],
      },
    );

    return template;
  }

  /**
   * Î≥¥Ïïà ÏúÑÌòë Í∞êÏßÄ Ïò§Î•ò Î©îÏãúÏßÄ
   */
  private generateSecurityThreatMessage(
    error: CursorDeploymentError,
    template: ErrorMessageTemplate,
  ): ErrorMessageTemplate {
    const threatType = error.details.threatType || 'unknown threat';

    template.sections.push(
      {
        type: 'error',
        title: 'Security Alert',
        content: [
          `A potential security threat was detected: ${threatType}`,
          'The deployment was stopped to protect your system.',
          'Please review the configuration carefully before proceeding.',
        ],
      },
      {
        type: 'steps',
        title: 'What to do next:',
        content: [
          '1. Review the flagged content:',
          '   ‚Ä¢ Check for suspicious scripts or commands',
          '   ‚Ä¢ Look for unexpected file paths or URLs',
          '   ‚Ä¢ Verify the source of the configuration',
          '',
          '2. If you trust the source:',
          '   ‚Ä¢ Remove or sanitize suspicious entries',
          '   ‚Ä¢ Use --force flag to bypass security checks (not recommended)',
          '',
          '3. If this seems like a false positive:',
          '   ‚Ä¢ Contact support with the deployment details',
          '   ‚Ä¢ Provide context about the configuration source',
        ],
      },
      {
        type: 'warning',
        title: 'Security Best Practices',
        content: [
          '‚Ä¢ Only deploy configurations from trusted sources',
          '‚Ä¢ Review all settings before deployment',
          '‚Ä¢ Keep your system and Cursor IDE updated',
          '‚Ä¢ Report false positives to help improve detection',
        ],
      },
    );

    return template;
  }

  /**
   * ÌÉÄÏûÑÏïÑÏõÉ Ïò§Î•ò Î©îÏãúÏßÄ
   */
  private generateTimeoutMessage(
    error: CursorDeploymentError,
    template: ErrorMessageTemplate,
  ): ErrorMessageTemplate {
    const operation = error.details.operation || 'deployment operation';
    const timeoutMs = error.details.timeoutMs || 'unknown';

    template.sections.push(
      {
        type: 'warning',
        title: 'What happened?',
        content: [
          `The ${operation} took too long and was cancelled.`,
          `Timeout: ${timeoutMs}ms`,
          'This can happen due to slow network, large files, or system performance issues.',
        ],
      },
      {
        type: 'steps',
        title: 'How to fix this:',
        content: [
          '1. Check your connection:',
          '   ‚Ä¢ Ensure stable internet connection',
          '   ‚Ä¢ Try again when network is less congested',
          '',
          '2. Optimize the deployment:',
          '   ‚Ä¢ Deploy smaller components separately',
          '   ‚Ä¢ Use --components flag to deploy specific parts',
          '   ‚Ä¢ Close unnecessary applications to free up resources',
          '',
          '3. System optimization:',
          '   ‚Ä¢ Restart your computer if performance is poor',
          '   ‚Ä¢ Check for system updates',
          '   ‚Ä¢ Ensure sufficient RAM and CPU resources',
        ],
      },
      {
        type: 'info',
        title: 'Alternative approaches:',
        content: [
          'Deploy components individually:',
          'taptik deploy --platform cursor-ide --components settings',
          'taptik deploy --platform cursor-ide --components extensions',
          'taptik deploy --platform cursor-ide --components ai-prompts',
        ],
      },
    );

    return template;
  }

  /**
   * Î°§Î∞± Ïã§Ìå® Ïò§Î•ò Î©îÏãúÏßÄ
   */
  private generateRollbackFailedMessage(
    error: CursorDeploymentError,
    template: ErrorMessageTemplate,
  ): ErrorMessageTemplate {
    const deploymentId = error.details.deploymentId || 'unknown';

    template.sections.push(
      {
        type: 'error',
        title: 'Critical: Rollback Failed',
        content: [
          'The automatic rollback process failed after a deployment error.',
          'Your Cursor IDE configuration may be in an inconsistent state.',
          'Manual recovery is required to restore functionality.',
        ],
      },
      {
        type: 'steps',
        title: 'Immediate Actions Required:',
        content: [
          '1. Do NOT use Cursor IDE until recovery is complete',
          '',
          '2. Locate backup files:',
          '   ~/.taptik/backups/cursor-ide/',
          '',
          '3. Manual recovery options:',
          '',
          '   Option A - Restore from backup:',
          '   ‚Ä¢ Find the most recent backup folder',
          '   ‚Ä¢ Copy files back to their original locations',
          '   ‚Ä¢ Verify Cursor IDE starts correctly',
          '',
          '   Option B - Fresh installation:',
          '   ‚Ä¢ Uninstall Cursor IDE completely',
          '   ‚Ä¢ Remove ~/.cursor directory',
          '   ‚Ä¢ Reinstall Cursor IDE',
          '   ‚Ä¢ Reconfigure manually',
          '',
          '4. Test Cursor IDE functionality',
        ],
      },
      {
        type: 'warning',
        title: 'Important Information',
        content: [
          `Deployment ID: ${deploymentId}`,
          'Save this ID for support requests',
          '',
          'Backup locations to check:',
          '‚Ä¢ ~/.taptik/backups/cursor-ide/',
          '‚Ä¢ ~/.taptik/cursor-deploy-state/',
        ],
      },
      {
        type: 'info',
        title: 'Need Help?',
        content: [
          'Contact support immediately with:',
          `‚Ä¢ Deployment ID: ${deploymentId}`,
          '‚Ä¢ Error details from this message',
          '‚Ä¢ Your operating system and Cursor IDE version',
          '',
          'Emergency recovery documentation:',
          'https://docs.taptik.dev/recovery/cursor-ide',
        ],
      },
    );

    return template;
  }

  /**
   * ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò Î©îÏãúÏßÄ
   */
  private generateNetworkErrorMessage(
    error: CursorDeploymentError,
    template: ErrorMessageTemplate,
  ): ErrorMessageTemplate {
    template.sections.push(
      {
        type: 'warning',
        title: 'Network Connection Issue',
        content: [
          'Unable to connect to required services during deployment.',
          'This could be due to internet connectivity or service availability.',
        ],
      },
      {
        type: 'steps',
        title: 'Troubleshooting Steps:',
        content: [
          '1. Check your internet connection:',
          '   ‚Ä¢ Try accessing other websites',
          '   ‚Ä¢ Test with: ping google.com',
          '',
          '2. Check service status:',
          '   ‚Ä¢ Visit status.taptik.dev for service updates',
          '   ‚Ä¢ Check if maintenance is scheduled',
          '',
          '3. Network troubleshooting:',
          '   ‚Ä¢ Restart your router/modem',
          '   ‚Ä¢ Try a different network (mobile hotspot)',
          '   ‚Ä¢ Check firewall/proxy settings',
          '',
          '4. Retry the deployment:',
          '   ‚Ä¢ Wait a few minutes and try again',
          '   ‚Ä¢ Use offline mode if available',
        ],
      },
      {
        type: 'info',
        title: 'Offline Options',
        content: [
          'If network issues persist, you can:',
          '‚Ä¢ Use previously cached configurations',
          '‚Ä¢ Deploy from local backup files',
          '‚Ä¢ Work offline and sync later when connection is restored',
        ],
      },
    );

    return template;
  }

  /**
   * ÌååÏùº ÏÜêÏÉÅ Ïò§Î•ò Î©îÏãúÏßÄ
   */
  private generateFileCorruptionMessage(
    error: CursorDeploymentError,
    template: ErrorMessageTemplate,
  ): ErrorMessageTemplate {
    const filePath = error.details.path || 'unknown file';

    template.sections.push(
      {
        type: 'error',
        title: 'File Corruption Detected',
        content: [
          `A configuration file appears to be corrupted: ${filePath}`,
          'This can happen due to incomplete writes, disk errors, or system crashes.',
          'The file needs to be restored or recreated.',
        ],
      },
      {
        type: 'steps',
        title: 'Recovery Options:',
        content: [
          '1. Automatic recovery (if backup exists):',
          '   ‚Ä¢ The system will attempt to restore from backup',
          '   ‚Ä¢ Check if Cursor IDE works after restoration',
          '',
          '2. Manual recovery:',
          '   ‚Ä¢ Delete the corrupted file',
          '   ‚Ä¢ Restart Cursor IDE (it will recreate defaults)',
          '   ‚Ä¢ Reconfigure your preferences',
          '',
          '3. From backup:',
          '   ‚Ä¢ Check ~/.taptik/backups/ for recent backups',
          '   ‚Ä¢ Copy the backup file to replace the corrupted one',
          '',
          '4. Complete reset:',
          '   ‚Ä¢ Remove ~/.cursor directory entirely',
          '   ‚Ä¢ Restart Cursor IDE for fresh configuration',
        ],
      },
      {
        type: 'warning',
        title: 'Prevention Tips',
        content: [
          '‚Ä¢ Regularly backup your Cursor IDE settings',
          '‚Ä¢ Don\'t force-quit Cursor IDE during configuration changes',
          '‚Ä¢ Check disk health if corruption happens frequently',
          '‚Ä¢ Keep your system updated and stable',
        ],
      },
    );

    return template;
  }

  /**
   * ÏùºÎ∞ò Ïò§Î•ò Î©îÏãúÏßÄ
   */
  private generateGenericErrorMessage(
    error: CursorDeploymentError,
    template: ErrorMessageTemplate,
  ): ErrorMessageTemplate {
    template.sections.push(
      {
        type: 'error',
        title: 'Deployment Error',
        content: [
          'An unexpected error occurred during Cursor IDE deployment.',
          'Please review the details below and try the suggested solutions.',
        ],
      },
      {
        type: 'info',
        title: 'Error Details',
        content: [
          `Error Code: ${error.code}`,
          `Category: ${error.category}`,
          `Severity: ${error.severity}`,
          `Timestamp: ${error.timestamp.toISOString()}`,
        ],
      },
      {
        type: 'steps',
        title: 'General Troubleshooting:',
        content: [
          '1. Try the deployment again:',
          '   ‚Ä¢ Some errors are temporary and may resolve on retry',
          '',
          '2. Check system requirements:',
          '   ‚Ä¢ Ensure Cursor IDE is properly installed',
          '   ‚Ä¢ Verify sufficient disk space and permissions',
          '',
          '3. Use diagnostic mode:',
          '   taptik deploy --platform cursor-ide --verbose --validate-only',
          '',
          '4. Get help:',
          '   ‚Ä¢ Check documentation at docs.taptik.dev',
          '   ‚Ä¢ Contact support with error details',
        ],
      },
    );

    // ÏÇ¨Ïö©Ïûê Ï†úÏïàÏÇ¨Ìï≠ Ï∂îÍ∞Ä
    if (error.suggestions.length > 0) {
      template.sections.push({
        type: 'info',
        title: 'Specific Suggestions',
        content: error.suggestions,
      });
    }

    return template;
  }

  /**
   * Ïò§Î•ò ÏΩîÎìúÎ≥Ñ Ï†úÎ™© ÏÉùÏÑ±
   */
  private getErrorTitle(code: CursorDeploymentErrorCode): string {
    const titles: Record<CursorDeploymentErrorCode, string> = {
      [CursorDeploymentErrorCode.PERMISSION_DENIED]: 'Permission Denied',
      [CursorDeploymentErrorCode.DISK_FULL]: 'Insufficient Disk Space',
      [CursorDeploymentErrorCode.TRANSFORMATION_FAILED]: 'Configuration Conversion Failed',
      [CursorDeploymentErrorCode.SECURITY_THREAT_DETECTED]: 'Security Threat Detected',
      [CursorDeploymentErrorCode.TIMEOUT]: 'Operation Timed Out',
      [CursorDeploymentErrorCode.ROLLBACK_FAILED]: 'Rollback Failed - Manual Recovery Required',
      [CursorDeploymentErrorCode.NETWORK_ERROR]: 'Network Connection Error',
      [CursorDeploymentErrorCode.FILE_CORRUPTION]: 'Configuration File Corrupted',
      [CursorDeploymentErrorCode.INVALID_CONTEXT]: 'Invalid Configuration Data',
      [CursorDeploymentErrorCode.MISSING_REQUIRED_FIELD]: 'Missing Required Configuration',
      [CursorDeploymentErrorCode.INCOMPATIBLE_VERSION]: 'Version Compatibility Issue',
      [CursorDeploymentErrorCode.INVALID_CONFIGURATION]: 'Invalid Configuration Format',
      [CursorDeploymentErrorCode.SCHEMA_VALIDATION_FAILED]: 'Configuration Schema Error',
      [CursorDeploymentErrorCode.PATH_NOT_FOUND]: 'Target Path Not Found',
      [CursorDeploymentErrorCode.FILE_LOCKED]: 'File Access Blocked',
      [CursorDeploymentErrorCode.DIRECTORY_NOT_WRITABLE]: 'Directory Write Permission Denied',
      [CursorDeploymentErrorCode.DATA_LOSS_DETECTED]: 'Potential Data Loss Detected',
      [CursorDeploymentErrorCode.UNSUPPORTED_FEATURE]: 'Unsupported Feature',
      [CursorDeploymentErrorCode.MAPPING_ERROR]: 'Configuration Mapping Error',
      [CursorDeploymentErrorCode.MALICIOUS_CONTENT]: 'Malicious Content Detected',
      [CursorDeploymentErrorCode.UNAUTHORIZED_ACCESS]: 'Unauthorized Access Attempt',
      [CursorDeploymentErrorCode.SENSITIVE_DATA_DETECTED]: 'Sensitive Data Found',
      [CursorDeploymentErrorCode.MEMORY_LIMIT_EXCEEDED]: 'Memory Limit Exceeded',
      [CursorDeploymentErrorCode.FILE_TOO_LARGE]: 'File Size Limit Exceeded',
      [CursorDeploymentErrorCode.RATE_LIMIT_EXCEEDED]: 'Rate Limit Exceeded',
      [CursorDeploymentErrorCode.SUPABASE_CONNECTION_FAILED]: 'Cloud Service Connection Failed',
      [CursorDeploymentErrorCode.DOWNLOAD_FAILED]: 'Download Failed',
      [CursorDeploymentErrorCode.CONFLICT_RESOLUTION_FAILED]: 'Conflict Resolution Failed',
      [CursorDeploymentErrorCode.MERGE_CONFLICT]: 'Configuration Merge Conflict',
      [CursorDeploymentErrorCode.BACKUP_FAILED]: 'Backup Creation Failed',
      [CursorDeploymentErrorCode.UNKNOWN_ERROR]: 'Unknown Error',
      [CursorDeploymentErrorCode.INTERNAL_ERROR]: 'Internal System Error',
      [CursorDeploymentErrorCode.CONFIGURATION_ERROR]: 'System Configuration Error',
    };

    return titles[code] || 'Deployment Error';
  }

  /**
   * ÏΩòÏÜîÏö© Í∞ÑÎã®Ìïú ÌÖçÏä§Ìä∏ Î©îÏãúÏßÄ ÏÉùÏÑ±
   */
  generateConsoleMessage(template: ErrorMessageTemplate): string {
    let message = `\n${template.icon} ${template.title}\n`;
    message += '='.repeat(template.title.length + 3) + '\n\n';
    message += `${template.description}\n\n`;

    for (const section of template.sections) {
      if (section.title) {
        message += `${this.getSectionIcon(section.type)} ${section.title}\n`;
      }

      if (Array.isArray(section.content)) {
        section.content.forEach(line => {
          message += `${line}\n`;
        });
      } else {
        message += `${section.content}\n`;
      }
      message += '\n';
    }

    return message;
  }

  /**
   * ÏÑπÏÖò ÌÉÄÏûÖÎ≥Ñ ÏïÑÏù¥ÏΩò Î∞òÌôò
   */
  private getSectionIcon(type: string): string {
    const icons = {
      info: '‚ÑπÔ∏è',
      warning: '‚ö†Ô∏è',
      error: '‚ùå',
      success: '‚úÖ',
      steps: 'üìã',
      code: 'üíª',
    };
    return icons[type] || '‚Ä¢';
  }

  /**
   * HTML ÌòïÌÉúÏùò Î©îÏãúÏßÄ ÏÉùÏÑ± (Ïõπ Ïù∏ÌÑ∞ÌéòÏù¥Ïä§Ïö©)
   */
  generateHtmlMessage(template: ErrorMessageTemplate): string {
    let html = `<div class="error-message error-${template.color}">`;
    html += `<div class="error-header">`;
    html += `<span class="error-icon">${template.icon}</span>`;
    html += `<h2 class="error-title">${template.title}</h2>`;
    html += `</div>`;
    html += `<p class="error-description">${template.description}</p>`;

    for (const section of template.sections) {
      html += `<div class="error-section error-section-${section.type}">`;
      
      if (section.title) {
        html += `<h3 class="section-title">${section.title}</h3>`;
      }

      if (Array.isArray(section.content)) {
        if (section.type === 'steps') {
          html += '<ol class="section-steps">';
          section.content.forEach(step => {
            if (step.trim()) {
              html += `<li>${this.escapeHtml(step)}</li>`;
            }
          });
          html += '</ol>';
        } else {
          html += '<ul class="section-list">';
          section.content.forEach(item => {
            if (item.trim()) {
              html += `<li>${this.escapeHtml(item)}</li>`;
            }
          });
          html += '</ul>';
        }
      } else {
        html += `<p class="section-content">${this.escapeHtml(section.content)}</p>`;
      }

      html += '</div>';
    }

    html += '</div>';
    return html;
  }

  /**
   * HTML Ïù¥Ïä§ÏºÄÏù¥ÌîÑ Ï≤òÎ¶¨
   */
  private escapeHtml(text: string): string {
    const div = { innerHTML: '' } as any;
    div.textContent = text;
    return div.innerHTML;
  }
}